<link rel="import" href="constants.html">
<script src="../../node_modules/reselect/dist/reselect.js"></script>
<link rel="import" href="../date-helpers.html">

<script>
  (() => {

    const getExpenses = state => state.expenses.expenses;
    const getFilters = state => state.filters.filters;
    const helpers = ExpenseManager.dateHelpers;

    const expenses = Reselect.createSelector(
      [getExpenses, getFilters],
      (expenses, filters) => {

        const merchant = filters.merchant;
        const min = filters.min;
        const max = filters.max;
        const status = filters.status;
        const start = filters.start;
        const end = filters.end;

        return expenses
          .filter(exp => !(merchant && exp.merchant.toUpperCase().indexOf(merchant.toUpperCase()) < 0))
          .filter(exp => !(min && exp.total < min))
          .filter(exp => !(max && exp.total > max))
          .filter(exp => {
            return status && status.length > 0 ? status.indexOf(exp.status) >= 0 : false;
          })
          .filter(exp => {
            return helpers.isValid(start) ? helpers.isAfterOrEqual(exp.date, start) : true;
          })
          .filter(exp => {
            return helpers.isValid(end) ? helpers.isBeforeOrEqual(exp.date, end) : true;
          });
      });


    const total = Reselect.createSelector([getExpenses], expenses => {
      return expenses
        .filter(exp => exp.status === 'new')
        .map(exp => exp.total)
        .reduce((sum, current) => sum + current, 0)
        .toFixed(2);
    });

    const merchants = Reselect.createSelector([getExpenses], expenses => {
      return expenses
        .map(e => e.merchant)
        .filter((val, index, self) => self.indexOf(val) === index);
    });

    const appliedFilters = Reselect.createSelector([getFilters], filters => {
      let numFilters = 0;

      Object.keys(filters).forEach(f => {
        const filter = filters[f];
        if (filter) {
          if (Array.isArray(filter)) {
            numFilters += ExpenseManager.constants.statuses.length - filter.length;
          } else {
            numFilters++;
          }
        }
      });
      return numFilters;
    });

    window.ExpenseManager = window.ExpenseManager || {};
    window.ExpenseManager.select = {
      expenses,
      merchants,
      appliedFilters,
      total
    };
  })();

</script>
