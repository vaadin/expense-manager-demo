<html><head><link rel="import" href="../polymer/polymer.html"><link rel="import" href="../iron-localstorage/iron-localstorage.html"><link rel="import" href="../iron-ajax/iron-ajax.html"><link rel="import" href="vaadin-license-box.html"><link rel="import" href="vaadin-license-dialog.html"><link rel="import" href="vaadin-license-notification.html"><link rel="import" href="vaadin-framework-identifier.html"></head><body><dom-module id="vaadin-license-checker"><template><iron-localstorage id="storageLicense" name="[[storageKey]]" value="{{licenseKey}}" use-raw="true"></iron-localstorage><iron-localstorage id="storageLicenseCheckTime" name="[[storageKeyCheckTime]]" value="{{licenseCheckTime}}" use-raw="true"></iron-localstorage><iron-localstorage id="storageLicenseType" name="[[storageKeyType]]" value="{{licenseKeyType}}" use-raw="true"></iron-localstorage><iron-ajax id="licenseRequest" url="[[licenseUrl]]" headers="[[licenseRequestHeaders]]" handle-as="json" on-response="_handleResultFromServer" on-error="_handleErrorFromServer" debounce-duration="300"></iron-ajax></template><script>LicenseChecker=Polymer({is:"vaadin-license-checker",instances:{},licenseDialog:void 0,licenseBox:void 0,notification:void 0,frameworkIdentifier:void 0,licenseTypes:{VALID:"valid",UNLICENSED:"unlicensed",TRIAL:"trial",EXPIRED:"expired"},properties:{licenseKey:{type:String,notify:!0},licenseCheckTime:{type:Number},licenseKeyType:{type:String},licenseUrlBase:{type:String,value:"https://tools.vaadin.com/vaadin-license-server/licenses/"},licenseUrl:{type:String,computed:"_computeUrl(licenseUrlBase, licenseKey)"},productName:String,productVersion:Number,productCaption:String,storageKey:{type:String,computed:"_computeStorageKey(productName)"},storageKeyCheckTime:{type:String,computed:"_computeStorageKeyCheckTime(productName)"},storageKeyType:{type:String,computed:"_computeStorageKeyType(productName)"},_yesterday:{type:Number,value:function(){var b=new Date;return b.setDate(b.getDate()-1),b.getTime()},readOnly:!0},_manualSubmit:{type:Boolean,value:!1},licenseRequestHeaders:String},attached:function(){this._exists(this.instances[this.storageKey])||(this.instances[this.storageKey]=this,this._isLocalhost()&&(this.$.storageLicense.reload(),this._exists(this.licenseKey)?this._checkLicenseKey():(this.licenseCheckTime===void 0&&(this.licenseCheckTime=window.localStorage.getItem(this._computeStorageKeyCheckTime(this.productName))),null===this.licenseCheckTime||this.licenseCheckTime<=this._yesterday?this._showLicenseDialog(this.licenseTypes.UNLICENSED):this._showLicenseBox(this.licenseTypes.UNLICENSED))))},detached:function(){this._existsAndAttached(this.licenseBox)&&(this._removeFromParent(this.licenseBox),this.licenseBox=void 0),this._existsAndAttached(this.licenseDialog)&&(this._removeFromParent(this.licenseDialog),this.licenseDialog=void 0),this._existsAndAttached(this.notification)&&(this._removeFromParent(this.notification),this.notification=void 0),this._existsAndAttached(this.frameworkIdentifier)&&(this._removeFromParent(this.frameworkIdentifier),this.frameworkIdentifier=void 0),this.instances[this.storageKey]===this&&(this.instances[this.storageKey]=void 0)},_removeFromParent:function(b){b.parentNode.removeChild(b)},_existsAndAttached:function(b){return b&&b.parentNode!=void 0},_checkLicenseKey:function(b,c){0===arguments.length&&(b=this.licenseKey);var d=this._computeUrl(this.licenseUrlBase,b);this._identifyFramework(),this._setLicenseRequestHeaders(),this.$.licenseRequest.url=d,this._manualSubmit=!!c,this.$.licenseRequest.generateRequest()},_computeUrl:function(b,c){return b+c},_handleErrorFromServer:function(){this._manualSubmit||null==this.licenseCheckTime||this.licenseCheckTime<=this._yesterday?(this._showLicenseDialog(this.licenseTypes.UNLICENSED),this.licenseKeyType=this.licenseTypes.UNLICENSED,this.licenseCheckTime=new Date().getTime()):this.licenseKeyType!==this.licenseTypes.VALID&&this._showLicenseBox(this.licenseKeyType||this.licenseTypes.UNLICENSED),this._fireLoadReadyEvent()},_handleResultFromServer:function(b){var c=b.detail,d=c.response;200==c.status&&this._isValidLicense(d.product.name,d.product.version)?!0===d.expired?(this.licenseKey=d.licenseKey,this._showLicenseBox(this.licenseTypes.EXPIRED),this.licenseKeyType=this.licenseTypes.EXPIRED):"evaluation"===d.type?(this.licenseKey=d.licenseKey,this._showLicenseBox(this.licenseTypes.TRIAL,d.expiredEpoch),this.licenseKeyType=this.licenseTypes.TRIAL):(this.licenseKey!==d.licenseKey&&(this._showSuccessNotification(),this.licenseKey=d.licenseKey),this.licenseKeyType=this.licenseTypes.VALID):(this._showLicenseDialog(this.licenseTypes.UNLICENSED),this.licenseKeyType=this.licenseTypes.UNLICENSED),this.licenseCheckTime=new Date().getTime(),this._fireLoadReadyEvent()},_isLocalhost:function(){var b=window.location.hostname;return"localhost"===b||"127.0.0.1"===b},_isValidLicense:function(b,c){return b===this.productName&&(c==this.productVersion||!this._exists(c))},_fireLoadReadyEvent:function(){this.fire("license-check-done")},_exists:function(b){return null!==b&&b!==void 0&&""!==b},_computeStorageKey:function(b){return"vaadin."+b+".developer.license.key"},_computeStorageKeyCheckTime:function(b){return"vaadin."+b+".license.check.time"},_computeStorageKeyType:function(b){return"vaadin."+b+".license.key.type"},_licenseDialogClosed:function(b){this._showLicenseBox(b.detail.type,b.detail.expiryEpoch),this.licenseCheckTime=new Date().getTime(),this._hideLicenseDialog()},_licenseBoxClosed:function(b){this._showLicenseDialog(b.detail.type,b.detail.expiryEpoch),this._hideLicenseBox()},_licenseBoxSubmit:function(b){this._checkLicenseKey(b.detail.licenseKey,!0),this.licenseCheckTime=new Date().getTime(),this._hideLicenseDialog()},_showLicenseDialog:function(b,c){this.licenseDialog||(this.licenseDialog=new LicenseDialog),Polymer.dom(document.body).appendChild(this.licenseDialog),this.hideLicenseDialogReference=this._licenseDialogClosed.bind(this),this.hideLicenseBoxSubmitReference=this._licenseBoxSubmit.bind(this),this.licenseDialog.addEventListener("vaadin-license-dialog-close",this.hideLicenseDialogReference),this.licenseDialog.addEventListener("vaadin-license-dialog-submit",this.hideLicenseBoxSubmitReference),this.licenseDialog.type=b,this.licenseDialog.productCaption=this.productCaption,b===this.licenseTypes.TRIAL&&(this.licenseDialog.expiryEpoch=c)},_hideLicenseDialog:function(){this.licenseDialog.removeEventListener("vaadin-license-dialog-close",this.hideLicenseDialogReference),this.licenseDialog.removeEventListener("vaadin-license-dialog-submit",this.hideLicenseBoxSubmitReference),Polymer.dom(document.body).removeChild(this.licenseDialog)},_showLicenseBox:function(b,c){this.licenseBox||(this.licenseBox=new LicenseBox),Polymer.dom(document.body).appendChild(this.licenseBox),this.hideLicenseBoxReference=this._licenseBoxClosed.bind(this),this.licenseBox.addEventListener("vaadin-license-box-close",this.hideLicenseBoxReference),this.licenseBox.type=b,this.licenseBox.productCaption=this.productCaption,b===this.licenseTypes.TRIAL&&(this.licenseBox.expiryEpoch=c)},_hideLicenseBox:function(){this.licenseBox.removeEventListener("vaadin-license-box-close",this.hideLicenseBoxReference),Polymer.dom(document.body).removeChild(this.licenseBox)},_showSuccessNotification:function(){this.notification||(this.notification=new LicenseNotification),Polymer.dom(this.root).appendChild(this.notification),this.hideSuccessReference=this._hideSuccessNotification.bind(this),this.notification.addEventListener("click",this.hideSuccessReference)},_hideSuccessNotification:function(){this.notification.removeEventListener("click",this.hideSuccessReference),Polymer.dom(this.root).removeChild(this.notification)},_identifyFramework:function(){this.frameworkIdentifier||(this.frameworkIdentifier=new FrameworkIdentifier,Polymer.dom(this).appendChild(this.frameworkIdentifier)),this.frameworkIdentifier.setFrameWorkAndVersion()},_setLicenseRequestHeaders:function(){this.licenseRequestHeaders={"check-source":"webcomponent",framework:this.frameworkIdentifier.framework,version:this.frameworkIdentifier.version,"product-name":this.productName,"product-version":this.productVersion}}});</script></dom-module></body></html>