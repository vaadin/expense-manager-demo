<html><head><link rel="import" href="../polymer/polymer.html">

<script>!function(){"use strict";"BluetoothDevice"in window||(window.BluetoothDevice={}),"BluetoothGATTRemoteServer"in window||(window.BluetoothGATTRemoteServer={}),"BluetoothGATTService"in window||(window.BluetoothGATTService={}),"BluetoothGATTCharacteristic"in window||(window.BluetoothGATTCharacteristic={}),Polymer({is:"platinum-bluetooth-characteristic",properties:{service:{type:String,observer:"_serviceChanged"},characteristic:{type:String,observer:"_characteristicChanged"},value:{type:ArrayBuffer,observer:"_valueChanged",notify:!0},autoWrite:{type:Boolean,reflectToAttribute:!0,value:!1},_device:{type:BluetoothDevice},_server:{readOnly:!0,type:BluetoothGATTRemoteServer},_service:{readOnly:!0,type:BluetoothGATTService},_characteristic:{readOnly:!0,type:BluetoothGATTCharacteristic}},_connectToDevice:function(){if(this._server)return Promise.resolve(this._server);if(!this._device)return Promise.reject(new Error("Bluetooth device is not connected."));var e=this;return this._device.connectGATT().then(function(t){return e._set_server(t),e._server})},_getPrimaryService:function(){if(this._service&&this._service.uuid===BluetoothUUID.getService(this.service))return Promise.resolve(this._service);if(!this._server||!this._server.connected)return Promise.reject(new Error("Bluetooth GATT Remote server is not connected."));if(!this.service)return Promise.reject(new Error("Bluetooth GATT Primary Service is mandatory."));var e=this;return this._server.getPrimaryService(this.service).then(function(t){if(!t)throw new Error("Bluetooth GATT Primary Service not found.");return e._set_service(t),e._service})},_getCharacteristic:function(){if(this._characteristic&&this._characteristic.uuid===BluetoothUUID.getCharacteristic(this.characteristic))return Promise.resolve(this._characteristic);if(!this._service)return Promise.reject(new Error("Bluetooth GATT Primary Service is not connected."));if(!this.characteristic)return Promise.reject(new Error("Bluetooth GATT Characteristic is mandatory."));var e=this;return this._service.getCharacteristic(this.characteristic).then(function(t){return e._set_characteristic(t),e._characteristic})},_readCharacteristic:function(){if(!this._characteristic)return Promise.reject(new Error("Bluetooth GATT Characteristic is not connected."));var e=this;return this._characteristic.readValue().then(function(t){return e.value=t,e.value})},_writeCharacteristic:function(e){return this._characteristic?this._characteristic.writeValue(e):Promise.reject(new Error("Bluetooth GATT Characteristic is not connected."))},_serviceChanged:function(){this._set_service(null),this._set_characteristic(null)},_characteristicChanged:function(){this._set_characteristic(null)},_valueChanged:function(){if(this.autoWrite){var e=this;this.write(this.value)["catch"](function(t){e.fire("platinum-bluetooth-auto-write-error",t.message||t)})}},read:function(){var e=this;return this._connectToDevice().then(function(){return e._getPrimaryService()}).then(function(){return e._getCharacteristic()}).then(function(){return e._readCharacteristic()})},write:function(e){var t=this;return this._connectToDevice().then(function(){return t._getPrimaryService()}).then(function(){return t._getCharacteristic()}).then(function(){return t._writeCharacteristic(e)})}})}();</script>
</head><body></body></html>