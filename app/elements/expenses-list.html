<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../scripts/accounting-js.html">
<link rel="import" href="../scripts/moment-js.html">
<link rel="import" href="search-filters.html">

<dom-module id="expenses-list">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
        overflow: hidden;
        @apply(--layout-vertical);
      }

      #add-button {
        position: absolute;
        right: 32px;
        bottom: 32px;
        z-index: 2;
      }

      #expenses {
        color: var(--primary-text-color);
        font-weight: 300;
      }

      #expenses ::content thead.vaadin-grid-header th,
      #expenses /deep/ thead.vaadin-grid-header th {
        background: var(--dark-primary-color);
        color: #ccc;
        font-size: 1.2em;
        font-weight: 400;
      }

      vaadin-grid ::content tr.vaadin-grid-row-stripe td,
      vaadin-grid /deep/ tr.vaadin-grid-row-stripe td {
        background: #F7F8F8;
      }

      #expenses ::content thead.vaadin-grid-header th.last-frozen,
      #expenses /deep/ thead.vaadin-grid-header th.last-frozen {
        border-right: 1px solid #2A3A42;
      }

      #expenses ::content .vaadin-grid-header.vaadin-grid .sort-asc.vaadin-grid:after,
      #expenses /deep/ .vaadin-grid-header.vaadin-grid .sort-asc.vaadin-grid:after {
        content: "\e7bc " attr(sort-order);
        font-family: Vaadin-Icons;
        font-size: 16px;
        speak: none;
        font-weight: normal;
        font-variant: normal;
        font-style: normal;
        text-transform: none;
        line-height: 1;
        -webkit-font-smoothing: antialiased;
        color: var(--default-primary-color);
      }

      #expenses ::content .vaadin-grid-header.vaadin-grid .sort-desc.vaadin-grid:after,
      #expenses /deep/ .vaadin-grid-header.vaadin-grid .sort-desc.vaadin-grid:after {
        content: "\e7c3 " attr(sort-order);
        font-family: Vaadin-Icons;
        font-size: 16px;
        speak: none;
        font-weight: normal;
        font-variant: normal;
        font-style: normal;
        text-transform: none;
        line-height: 1;
        -webkit-font-smoothing: antialiased;
        color: var(--default-primary-color);
      }
    </style>


    <search-filters filters="{{filters}}"></search-filters>

    <vaadin-grid class="flex" id="expenses" frozen-columns="1">
      <table>
        <colgroup>
          <col header-text="Date" name="date" sortable/>
          <col header-text="Merchant" name="merchant" sortable/>
          <col header-text="Total" name="total" sortable/>
          <col header-text="Status" name="status" sortable/>
          <col header-text="Comment" name="comment" sortable/>
        </colgroup>
      </table>
    </vaadin-grid>
    <paper-fab icon="add" on-tap="_showExpenseEditor" id="add-button"></paper-fab>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'expenses-list',

        properties: {
          service: Object,
          sortColumn: String,
          sortDirection: String,
          filters: {
            type: Object,
            value: function () {
              return {};
            }
          }
        },

        observers: [
          '_filtersChanged(filters.*)'
        ],

        ready: function () {
          var grid = this.$.expenses;
          var _this = this;

          grid.columns[0].renderer = function (cell) {
            cell.element.innerHTML = moment(cell.data).format('YYYY-MM-DD');
          };

          grid.columns[2].renderer = function (cell) {
            cell.element.innerHTML = accounting.formatMoney(cell.data);
          };

          grid.addEventListener('sort-order-changed', function () {
            grid.scrollToStart();
          });

          grid.addEventListener('select', function () {
            var selection = grid.selection.selected();
            if (selection.length === 1) {
              grid.getItem(selection[0], function (err, item) {
                _this.fire('edit-expense', {
                  expense: item
                });
              });
            }
          });

          this._setDataSource();
        },

        _setDataSource: function () {
          var _this = this;
          var grid = this.$.expenses;
          grid.datasource = function (req) {
            var queryParams = {
              index: req.index,
              count: req.count,
              min: _this.filters.min,
              max: _this.filters.max,
              merchant: _this.filters.merchant,
              start: _this.filters.start,
              end: _this.filters.end
            };

            if (req.sortOrder && req.sortOrder[0]) {
              queryParams.sort = grid.columns[req.sortOrder[0].column].name;
              queryParams.direction = req.sortOrder[0].direction;
            }

            _this.service.getExpenses(queryParams).then(function (json) {
              req.success(json.result, json.metadata.totalcount);
            });
          };
        },

        update: function () {
          var grid = this.$.expenses;
          if (grid.datasource) {
            grid.clearCache();
            grid.scrollToStart();
          }
        },

        _showExpenseEditor: function () {
          this.fire('edit-expense', {});
        },

        _filtersChanged: function () {
          if (this.$.expenses.datasource) {
            var _this = this;
            this.debounce('_filtersChanged', function () {
              _this.update();

            }, 300);
          }

        }
      });
    })();
  </script>
</dom-module>
